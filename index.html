<!DOCTYPE html>
<html lang="ru" data-theme="amoled-pink">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no" />
  <title>–ø—Ä–æ—Å—Ç–∏ –º–µ–Ω—è üíå</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --bg:#000; --bg-soft:#0a0810;
      --pink:#ff4fa3; --pink-2:#ff84d8; --hot:#ff2d7a;
      --text:#fff; --muted:#cec7d2;
      --glass:rgba(255,255,255,.06); --glass-2:rgba(255,255,255,.12);
      --shadow:0 0 24px rgba(255,51,153,.55), 0 0 48px rgba(255,51,153,.25);
      --radius:18px;
      --font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
    }
    html[data-theme="extra-pink"]{
      --bg:#0a0007; --bg-soft:#140011;
      --pink:#ff5bb5; --pink-2:#ffa3e2; --hot:#ff2d9a;
      --glass:rgba(255,20,147,.08); --glass-2:rgba(255,20,147,.16);
      --shadow:0 0 30px rgba(255,20,147,.55), 0 0 60px rgba(255,20,147,.28);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:var(--font);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,30,120,.12) 0%, transparent 60%),
        radial-gradient(900px 500px at 80% 80%, rgba(255,120,220,.08) 0%, transparent 60%),
        var(--bg);
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent;
    }
    body::before{
      content:""; position:fixed; inset:-18vmax; z-index:0; pointer-events:none;
      background:
        radial-gradient(ellipse at 30% 30%, rgba(255,77,160,.08), transparent 60%),
        radial-gradient(ellipse at 70% 70%, rgba(255,150,230,.06), transparent 60%);
      filter:blur(40px); animation:aura 8s ease-in-out infinite;
      will-change: transform;
    }
    @keyframes aura{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}

    .wrap{
      position:relative;
      min-height:100vh;
      min-height:100dvh; /* –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
      display:grid; place-items:center;
      padding:32px 16px;
      padding-top: calc(env(safe-area-inset-top, 0px) + 18px);
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 18px);
      z-index:1;
    }

    .card{
      position:relative; width:min(780px,95vw); padding:clamp(18px,3vw,28px);
      border-radius:var(--radius); background:linear-gradient(180deg,var(--glass-2),var(--glass));
      border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow);
      backdrop-filter:blur(12px) saturate(120%); -webkit-backdrop-filter:blur(12px) saturate(120%);
      overflow:visible; /* —á—Ç–æ–±—ã –≤–µ—Ä—Ö –∫–æ–Ω–≤–µ—Ä—Ç–∞ –Ω–µ –æ–±—Ä–µ–∑–∞–ª—Å—è */
      isolation:isolate;
    }
    .card::before{
      content:""; position:absolute; inset:-2px;
      background:conic-gradient(from 0deg,var(--pink),transparent 30%,var(--pink-2),transparent 60%,var(--pink));
      filter:blur(22px); opacity:.28; z-index:-1; animation:spin 10s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .title{display:flex;align-items:center;gap:12px;margin:0 0 10px}
    .heart{font-size:20px;filter:drop-shadow(0 0 10px rgba(255,51,153,.6));animation:throb 2s ease-in-out infinite}
    @keyframes throb{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
    .subtitle{margin:0 0 16px;color:var(--muted);font-size:clamp(.95rem,2.6vw,1rem)}
    .glow{background:linear-gradient(90deg,#fff,#ffe4f7,#ffd0f0);-webkit-background-clip:text;background-clip:text;color:transparent}

    .stage{display:grid;place-items:center;padding:18px 8px 8px}

    /* ===== ENVELOPE =====
       –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é --scale –∏ –≤—Ä–∞—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ --rot */
    .envelope{
      --w: min(440px, 94vw);
      --scale: 1;
      width:var(--w);
      height:calc(var(--w) * 0.60); /* –±–∞–∑–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ (–∑–∞–∫—Ä—ã—Ç) */
      position:relative; cursor:pointer; user-select:none;
      perspective:1200px; transform-style:preserve-3d;
      outline:none; transition:height .45s cubic-bezier(.22,1,.27,1);
      touch-action: manipulation;
      transform-origin: top center;
      transform: var(--rot, none) scale(var(--scale));
      will-change: transform, height;
      contain: layout paint size;
    }
    .envelope:focus-visible{ box-shadow:0 0 0 2px var(--pink-2); border-radius:16px }
    .pocket{
      position:absolute; inset:0; z-index:1;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12); border-radius:16px;
      clip-path:polygon(0 0,100% 0,100% 70%,50% 100%,0 70%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 12px 22px rgba(0,0,0,.45);
      background-color:#111016;
    }
    .flap{
      position:absolute; inset:0; z-index:3; transform-origin:50% 0%;
      transform:rotateX(0deg) translateZ(2px);
      transition:transform .9s cubic-bezier(.22,1,.27,1);
      clip-path:polygon(0 0,100% 0,50% 56%);
      background:linear-gradient(180deg,#ff7ac5,#d8007a);
      filter:drop-shadow(0 10px 20px rgba(255,51,153,.45));
      border-top-left-radius:16px;border-top-right-radius:16px;
      backface-visibility:hidden;-webkit-backface-visibility:hidden;
      will-change: transform;
    }
    .flap::after{content:""; position:absolute; inset:0; clip-path:polygon(0 0,100% 0,50% 56%); background:linear-gradient(180deg,rgba(255,255,255,.35),transparent 55%); mix-blend-mode:screen; opacity:.25}
    .seal{
      position:absolute; left:50%; top:56%; transform:translate(-50%,-50%); z-index:4;
      background:radial-gradient(circle at 30% 30%,var(--pink-2),var(--pink));
      color:#10010a; font-weight:800; padding:12px 16px; border-radius:999px;
      border:1px solid rgba(255,255,255,.75); box-shadow:0 6px 18px rgba(255,51,153,.55);
      text-shadow:0 1px 0 rgba(255,255,255,.4); white-space:nowrap;
      transition:transform .45s ease, opacity .45s ease;
    }

    .letter{
      position:absolute; left:6%; right:6%; top:14%; z-index:2;
      height:72%;
      background:linear-gradient(180deg,#1a1a22,#0f0f14); border:1px solid rgba(255,255,255,.1);
      border-radius:12px; padding:18px 16px 18px;
      transform:translateY(32%) rotateX(-16deg) translateZ(4px);
      transform-origin:50% 100%;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 16px 30px rgba(0,0,0,.55);
      opacity:0; transition: transform 1s cubic-bezier(.22,1,.27,1), opacity .6s ease, height .45s cubic-bezier(.22,1,.27,1);
      overflow:hidden;
      will-change: transform, height;
    }
    .envelope.open .letter{
      height:auto;
      opacity:1; transform:translateY(-8%) rotateX(0deg) translateZ(4px);
      overflow:visible;
    }

    .letter h2{margin:0 0 10px;font-size:clamp(18px,2.4vw,22px)}
    .type{
      font-size:clamp(15px,3.2vw,17px);
      line-height:1.7; color:#f7e9f5; opacity:.96;
      margin:6px 0; padding-right:8px; position:relative;
      overflow-wrap:anywhere; hyphens:auto;
    }
    .cursor{display:inline-block;width:8px;height:1.1em;background:var(--pink-2);margin-left:2px;vertical-align:-2px;animation:blink .9s steps(1,end) infinite}
    @keyframes blink{50%{opacity:0}}

    .cta{text-align:center;margin-top:14px;color:var(--muted);font-size:clamp(.92rem,3.2vw,1rem)}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:16px}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));
      color:var(--text);padding:12px 16px;border-radius:999px;cursor:pointer;
      transition:transform .15s ease, box-shadow .2s ease, background .2s ease;
      box-shadow:0 8px 16px rgba(0,0,0,.35);
      backdrop-filter:blur(8px) saturate(120%); -webkit-backdrop-filter:blur(8px) saturate(120%);
      font-weight:600;user-select:none;position:relative;overflow:hidden;
      touch-action: manipulation; min-height:44px;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.4), 0 0 16px rgba(255,51,153,.35)}
    .btn:active{transform:translateY(0) scale(.99)}
    .btn::after{content:"";position:absolute;inset:0;background:radial-gradient(circle,rgba(255,255,255,.28),transparent 45%);opacity:0;transform:scale(0);transition:transform .35s,opacity .35s}
    .btn:active::after{opacity:1;transform:scale(1);transition:none}

    .envelope.open .flap{transform:rotateX(180deg) translateZ(1px);z-index:0}
    .envelope.open .seal{transform:translate(-50%,-50%) scale(.85);opacity:.08}

    .floaters{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
    .heart-f{position:absolute;font-size:clamp(12px,3.5vw,18px);opacity:.08;animation:floatUp linear infinite;filter:drop-shadow(0 0 8px rgba(255,60,150,.55))}
    @keyframes floatUp{from{transform:translateY(110vh)}to{transform:translateY(-20vh)}}

    .confetti{position:fixed;inset:0;pointer-events:none;z-index:9}
    .piece{position:absolute;width:10px;height:10px;background:currentColor;border-radius:2px;transform:translate(-50%,-50%);animation:burst 1.2s ease-out forwards;mix-blend-mode:screen}
    .piece.heart::before{content:"‚ù§";font-size:14px;position:absolute;inset:-2px auto auto -2px;color:currentColor;background:none}
    @keyframes burst{0%{opacity:0;transform:translate(-50%,-50%) scale(.4)}10%{opacity:1}100%{opacity:0;transform:translate(var(--dx),var(--dy)) rotate(680deg) scale(.9)}}

    .spark{position:fixed;width:6px;height:6px;border-radius:50%;background:radial-gradient(circle,#fff,var(--pink-2));pointer-events:none;filter:blur(.2px) drop-shadow(0 0 6px rgba(255,51,153,.8));animation:fade .8s ease-out forwards;z-index:10}
    @keyframes fade{to{transform:translateY(-8px) scale(0);opacity:0}}
    .boom{position:fixed;left:0;top:0;font-size:28px;transform:translate(-50%,-50%);animation:rise 900ms ease-out forwards;filter:drop-shadow(0 0 8px rgba(255,51,153,.7));pointer-events:none;z-index:10}
    @keyframes rise{from{opacity:0;transform:translate(-50%,-30%) scale(.8)}to{opacity:1;transform:translate(-50%,-120%) scale(1.4)}}

    /* –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ */
    @media (max-width:480px){
      .card{ padding:20px 14px; }
      .actions .btn{ flex:1 1 100%; }
    }

    /* LITE: –æ—Ç–∫–ª—é—á–∞–µ–º —Ç—è–∂—ë–ª—ã–µ –±–ª–∏–∫–∏/–∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
    html[data-perf="lite"] body::before,
    html[data-perf="lite"] .card::before{ display:none !important; }
    html[data-perf="lite"] .heart{ animation: none !important; }
    html[data-perf="lite"] .flap::after{ opacity:.15; }
  </style>
</head>
<body>
  <div class="floaters" aria-hidden="true"></div>

  <main class="wrap">
    <section class="card">
      <h1 class="title"><span class="heart">üíó</span><span class="glow">–º–æ–µ –ø–∏—Å—å–º–æ ^^</span></h1>
      <p class="subtitle">–Ω–∞–∂–º–∏ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç ‚Äî –∏ —è —Å–∫–∞–∂—É —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ</p>

      <div class="stage">
        <div class="envelope" id="envelope" role="button" tabindex="0" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç">
          <div class="pocket"></div>
          <div class="flap"></div>
          <div class="seal"><strong>–ü—Ä–æ—Å—Ç–∏ –º–µ–Ω—è</strong><small>–Ω–∞–∂–º–∏ —Å—é–¥–∞</small></div>

          <div class="letter" id="letter">
            <h2 class="glow">–û—Ç –≤—Å–µ–≥–æ —Å–µ—Ä–¥—Ü–∞</h2>
            <p class="type" data-text="–ø—Ä–æ—Å—Ç–∏ –º–µ–Ω—è. —è –ø—Ä–∞–≤–¥–∞ –≤–∏–Ω–æ–≤–∞—Ç"></p>
            <p class="type" data-text="—è –æ—á–µ–Ω—å —Å–∫—É—á–∞—é –ø–æ —Ç–µ–±–µ: –ø–æ –≥–æ–ª–æ—Å—É, –ø–æ —Ç–≤–æ–∏–º –∑–∞–±–∞–≤–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –∏ –ø–æ —Ç–æ–º—É, –∫–∞–∫ —Ç–≤–æ—ë –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ–ª–∞–µ—Ç –¥–µ–Ω—å —Ç–µ–ø–ª–µ–µ <3"></p>
            <p class="type" data-text="—Å–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∞. —è –∑–¥–µ—Å—å ‚ù§Ô∏è"></p>

            <div class="actions">
              <button class="btn" id="replay">–ü–µ—Ä–µ–∏–≥—Ä–∞—Ç—å –º–∞–≥–∏—é ‚ú®</button>
              <button class="btn" id="theme">–°–¥–µ–ª–∞—Ç—å –µ—â—ë —Ä–æ–∑–æ–≤–µ–µ üå∏</button>
              <button class="btn" id="music">–ù–µ–º–Ω–æ–≥–æ –º—É–∑—ã–∫–∏ üéµ</button>
              <button class="btn" id="share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è üí¨</button>
            </div>
          </div>
        </div>
        <p class="cta">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–∂–º–∏ –Ω–∞ —Ä–æ–∑–æ–≤—É—é –ø–µ—á–∞—Ç—å ¬´–ü—Ä–æ—Å—Ç–∏ –º–µ–Ω—è¬ª.</p>
      </div>
    </section>
  </main>

  <div class="confetti" id="confetti" aria-hidden="true"></div>
  <audio id="song" preload="auto" src="music.mp3"></audio>

  <script>
    /* ===== PERF / LITE ===== */
    const isCoarse = matchMedia('(pointer:coarse)').matches;
    const saveData = navigator.connection && navigator.connection.saveData;
    const lowMem   = navigator.deviceMemory && navigator.deviceMemory <= 4;
    const lowCPU   = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;
    const perfLite = isCoarse || saveData || lowMem || lowCPU;
    document.documentElement.dataset.perf = perfLite ? 'lite' : 'full';

    /* ===== FLOATING HEARTS (–º–µ–Ω—å—à–µ –Ω–∞ –º–æ–±–∏–ª–µ) ===== */
    (function(){
      const root = document.querySelector('.floaters');
      const COUNT = perfLite ? 12 : 24;
      const emojis = ['‚ù§','üíñ','üíó','üíì','üíû','‚ú®'];
      for(let i=0;i<COUNT;i++){
        const el = document.createElement('div'); el.className='heart-f';
        el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
        el.style.left = Math.random()*100+'vw';
        const dur = (perfLite?14:18)+Math.random()*(perfLite?10:20);
        const delay = -Math.random()*dur;
        el.style.animationDuration = dur+'s'; el.style.animationDelay = delay+'s';
        root.appendChild(el);
      }
    })();

    const envelope = document.getElementById('envelope');
    const letter   = document.getElementById('letter');
    const confetti = document.getElementById('confetti');
    const replayBtn= document.getElementById('replay');
    const themeBtn = document.getElementById('theme');
    const musicBtn = document.getElementById('music');
    const shareBtn = document.getElementById('share');
    const song     = document.getElementById('song');

    let openedOnce=false;
    let closedHeight = parseFloat(getComputedStyle(envelope).height);

    envelope.addEventListener('click', openEnvelope);
    envelope.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openEnvelope(); }});
    replayBtn.addEventListener('click', resetEnvelope);

    function openEnvelope(){
      if(envelope.classList.contains('open')) return;
      envelope.classList.add('open');
      typeAll();
      adjustEnvelope();      // –ø–æ–¥–≥–æ–Ω –≤—ã—Å–æ—Ç—ã
      fitEnvelopeToScreen(); // –∏ –≤–ø–∏—Å—ã–≤–∞–Ω–∏–µ –≤ —ç–∫—Ä–∞–Ω
      burstConfetti();
      try{ navigator.vibrate && navigator.vibrate(8);}catch(e){}
      if(!perfLite) startMusic();
      openedOnce = true;
    }
    function resetEnvelope(){
      envelope.classList.remove('open');
      envelope.style.setProperty('--scale', 1);
      envelope.style.removeProperty('--rot');
      envelope.style.height = closedHeight+'px';
      letter.style.height = '';
      document.querySelectorAll('.type').forEach(p=> p.textContent='');
      setTimeout(openEnvelope,120);
    }

    /* ===== –ü–ê–†–ê–õ–õ–ê–ö–° ‚Äî —Ç–æ–ª—å–∫–æ –¥–µ—Å–∫—Ç–æ–ø ===== */
    if(!isCoarse && !perfLite){
      let rect=null, maxTilt=8;
      envelope.addEventListener('pointerenter',()=> rect=envelope.getBoundingClientRect());
      envelope.addEventListener('pointermove',e=>{
        if(!rect) rect=envelope.getBoundingClientRect();
        const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
        const dx=(e.clientX-cx)/(rect.width/2), dy=(e.clientY-cy)/(rect.height/2);
        envelope.style.setProperty('--rot', `rotateX(${(-dy*maxTilt).toFixed(1)}deg) rotateY(${(dx*maxTilt).toFixed(1)}deg)`);
      });
      envelope.addEventListener('pointerleave',()=> envelope.style.setProperty('--rot','none'));
    }

    /* ===== –ü–ï–ß–ê–¢–¨ ===== */
    function typeLine(el, text, speed= perfLite ? 22 : 26){
      return new Promise(resolve=>{
        let i=0; const cursor=document.createElement('span'); cursor.className='cursor'; el.appendChild(cursor);
        function step(){
          let chunk = perfLite ? 3 : 2;           // –ø–µ—á–∞—Ç–∞–µ–º –ø–∞—á–∫–∞–º–∏
          while(chunk-- && i < text.length){
            el.insertBefore(document.createTextNode(text[i]), cursor);
            i++;
          }
          if(i < text.length){
            requestAnimationFrame(step);
          }else{
            cursor.remove(); resolve();
          }
        }
        step();
      });
    }
    async function typeAll(){
      const lines=[...document.querySelectorAll('.type')];
      for(const line of lines){
        const text=line.getAttribute('data-text')||'';
        await typeLine(line,text);
        adjustEnvelope();
        fitEnvelopeToScreen();
        if(!perfLite) await new Promise(r=> setTimeout(r,160));
      }
    }

    /* ===== –ê–í–¢–û-–í–´–°–û–¢–ê ===== */
    function adjustEnvelope(){
      if(!envelope.classList.contains('open')) return;
      letter.style.height='auto';
      const letterH = letter.scrollHeight;
      const bottomReserve = 28;
      const targetH = Math.max(closedHeight, Math.ceil((letterH + bottomReserve)/0.86));
      envelope.style.height = targetH + 'px';
    }

    /* ===== –í–ü–ò–°–´–í–ê–ù–ò–ï –í –≠–ö–†–ê–ù (–≥–ª–∞–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) =====
       –ï—Å–ª–∏ –∏—Ç–æ–≥–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞ –±–æ–ª—å—à–µ –¥–æ—Å—Ç—É–ø–Ω–æ–π ‚Äî —É–º–µ–Ω—å—à–∞–µ–º –º–∞—Å—à—Ç–∞–±–æ–º. */
    function fitEnvelopeToScreen(){
      const rect = envelope.getBoundingClientRect();
      const vh = Math.max(window.innerHeight, document.documentElement.clientHeight);
      // –∑–∞–ø–∞—Å —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–æ–∫/–ø–æ–¥—Å–∫–∞–∑–∫—É
      const safeTop = 140;   // –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–æ–∫
      const safeBottom = 120; // –ø–æ–¥ –ø–æ–¥—Å–∫–∞–∑–∫—É/–Ω–∏–∂–Ω—é—é –ø–∞–Ω–µ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
      const maxH = Math.max(240, vh - (safeTop + safeBottom));
      const scale = Math.min(1, maxH / rect.height);
      envelope.style.setProperty('--scale', scale.toFixed(3));
    }

    if('ResizeObserver' in window){
      new ResizeObserver(()=> { adjustEnvelope(); fitEnvelopeToScreen(); }).observe(letter);
    }
    window.addEventListener('resize', ()=>{ closedHeight = parseFloat(getComputedStyle(envelope).height); fitEnvelopeToScreen(); });

    /* ===== –ö–û–ù–§–ï–¢–¢–ò ===== */
    function burstConfetti(){
      const pieces = perfLite ? 24 : (isCoarse ? 40 : 80);
      const colors=['#ff4fa3','#ff84d8','#ffd1f1','#ffffff'];
      const r=envelope.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height*0.52;
      for(let i=0;i<pieces;i++){
        const p=document.createElement('div'); p.className='piece'+(Math.random()>.45?' heart':'');
        p.style.left=cx+'px'; p.style.top=cy+'px';
        const angle=Math.random()*Math.PI*2, dist=60+Math.random()*(perfLite?160:240);
        p.style.setProperty('--dx', Math.cos(angle)*dist+'px');
        p.style.setProperty('--dy', Math.sin(angle)*dist-30+'px');
        p.style.color=colors[Math.floor(Math.random()*colors.length)];
        confetti.appendChild(p); setTimeout(()=>p.remove(),1200);
      }
    }

    // ¬´–∏—Å–∫—Ä—ã¬ª –∑–∞ –º—ã—à–∫–æ–π ‚Äî —Ç–æ–ª—å–∫–æ –¥–µ—Å–∫—Ç–æ–ø
    if(!isCoarse && !perfLite){
      let lastSpark=0;
      window.addEventListener('pointermove',e=>{
        const now=performance.now(); if(now-lastSpark<18) return; lastSpark=now;
        const s=document.createElement('div'); s.className='spark'; s.style.left=(e.clientX-3)+'px'; s.style.top=(e.clientY-3)+'px';
        document.body.appendChild(s); setTimeout(()=>s.remove(),900);
      },{passive:true});
    }

    // –º–∞–ª–µ–Ω—å–∫–æ–µ —Å–µ—Ä–¥–µ—á–∫–æ –Ω–∞ –∫–ª–∏–∫
    window.addEventListener('click',e=>{
      const h=document.createElement('div'); h.className='boom';
      h.textContent=['üíñ','üíó','üíû','‚ú®'][Math.floor(Math.random()*4)];
      h.style.left=e.clientX+'px'; h.style.top=e.clientY+'px';
      document.body.appendChild(h); setTimeout(()=>h.remove(),900);
    });

    /* —Ç–µ–º—ã */
    themeBtn.addEventListener('click', ()=>{
      const html=document.documentElement;
      const next=html.getAttribute('data-theme')==='extra-pink'?'amoled-pink':'extra-pink';
      html.setAttribute('data-theme', next);
      themeBtn.textContent = next==='extra-pink'?'–°–¥–µ–ª–∞—Ç—å —Å–ø–æ–∫–æ–π–Ω–µ–µ üñ§':'–°–¥–µ–ª–∞—Ç—å –µ—â—ë —Ä–æ–∑–æ–≤–µ–µ üå∏';
    });

    /* –º—É–∑—ã–∫–∞ ‚Äî –≤—Ä—É—á–Ω—É—é –ø–æ –∫–Ω–æ–ø–∫–µ (–≤ lite –Ω–µ –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç—É–µ—Ç) */
    let musicOn=false, ctx, gain, beatTimer;
    function startMusic(){
      if(song && song.src && !song.src.endsWith('#disabled')){
        song.volume=.55; song.loop=true; song.play().catch(()=>{}); musicOn=true; musicBtn.textContent='–ü–∞—É–∑–∞ üéµ'; return;
      }
      if(!ctx){ ctx=new (window.AudioContext||window.webkitAudioContext)(); gain=ctx.createGain(); gain.gain.value=.05; gain.connect(ctx.destination); }
      const osc=ctx.createOscillator(); osc.type='sine'; osc.frequency.value=432; osc.connect(gain); osc.start();
      beatTimer=setInterval(()=>{ const g=gain.gain, v=g.value; g.setValueAtTime(v,ctx.currentTime); g.linearRampToValueAtTime(v*3,ctx.currentTime+.06); g.linearRampToValueAtTime(v,ctx.currentTime+.5); },1200);
      musicOn=true; musicBtn.textContent='–ü–∞—É–∑–∞ üéµ';
    }
    function stopMusic(){ if(song && !song.paused) song.pause(); if(ctx){ctx.close();ctx=null;clearInterval(beatTimer)} musicOn=false; musicBtn.textContent='–ù–µ–º–Ω–æ–≥–æ –º—É–∑—ã–∫–∏ üéµ'; }
    musicBtn.addEventListener('click', ()=> musicOn?stopMusic():startMusic());

    /* –ø–æ–¥–µ–ª–∏—Ç—å—Å—è */
    shareBtn.addEventListener('click', async ()=>{
      const text=[...document.querySelectorAll('.type')].map(p=>p.getAttribute('data-text')).join('\n');
      try{ if(navigator.share){ await navigator.share({title:'–ü—Ä–æ—Å—Ç–∏ –º–µ–Ω—è üíå', text}); } else { await navigator.clipboard.writeText(text); shareBtn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ'; setTimeout(()=>shareBtn.textContent='–ü–æ–¥–µ–ª–∏—Ç—å—Å—è üí¨',1200);} }
      catch(e){}
    });

    // –ø–æ–¥—Å–∫–∞–∑–∫–∞-¬´–ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏–µ¬ª
    setTimeout(()=>{ if(!openedOnce){ envelope.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:800,iterations:1}); }},900);
  </script>
</body>
</html>
